<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Card Gallery</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }

        .transition-all {
            transition-property: all;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 150ms;
        }

        .lightbox-img-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
        }

        .aspect-4-5 {
            position: relative;
            padding-bottom: 125%;
            width: 100%;
            border-radius: 0.5rem;
        }

        .aspect-4-5 .lazy-svg-object {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: 100%;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        .aspect-4-5 .lazy-svg-object.loaded {
            opacity: 1;
        }

        #lightbox-svg-content object {
            max-width: 100%;
            max-height: 100%;
        }
    </style>
</head>
<body>

<div class="container mx-auto p-4 md:p-8">
    <h1 class="text-3xl font-extrabold text-gray-800 mb-6 text-center">Card Gallery</h1>
    <p class="text-center text-sm text-gray-500 mb-8">
        Click cards to zoom in. In zoomed-in view, use <kbd class="inline-block px-2 py-1 text-xs font-semibold text-gray-800 bg-white border border-gray-300 rounded-lg shadow-sm">←</kbd> and <kbd class="inline-block px-2 py-1 text-xs font-semibold text-gray-800 bg-white border border-gray-300 rounded-lg shadow-sm">→</kbd> for navigation or press <kbd class="inline-block px-2 py-1 text-xs font-semibold text-gray-800 bg-white border border-gray-300 rounded-lg shadow-sm">ESC</kbd> to close.
    </p>

    <div id="svg-grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-6">
        <!-- SVG Thumbnails will be injected here -->
    </div>
</div>

<!-- The Full-Screen Lightbox Modal (Initially Hidden) -->
<div id="lightbox" class="fixed inset-0 bg-black bg-opacity-95 hidden transition-all z-50 p-4" aria-modal="true"
     role="dialog">

    <button id="close-btn"
            class="absolute top-4 right-4 text-white text-3xl p-3 bg-gray-700/50 hover:bg-red-600/70 rounded-full transition-all z-50 shadow-lg"
            aria-label="Close image viewer">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"
             stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
        </svg>
    </button>

    <button id="prev-btn"
            class="absolute left-4 top-1/2 -translate-y-1/2 text-white text-3xl p-4 bg-gray-700/50 hover:bg-gray-500/80 rounded-full transition-all shadow-lg"
            aria-label="Previous image">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"
             stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
        </svg>
    </button>

    <button id="next-btn"
            class="absolute right-4 top-1/2 -translate-y-1/2 text-white text-3xl p-4 bg-gray-700/50 hover:bg-gray-500/80 rounded-full transition-all shadow-lg"
            aria-label="Next image">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"
             stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/>
        </svg>
    </button>

    <div id="lightbox-svg-content" class="lightbox-img-container">
        <!-- Enlarged image will be injected here -->
    </div>

</div>

<script>
    const svgFiles = [
        {% for fname in card_files %}
        { path: "{{str(fname)}}", name: "{{str(fname.name)}}" },
        {% endfor %}
    ];

    let currentIndex = 0;
    const svgGrid = document.getElementById('svg-grid');
    const lightbox = document.getElementById('lightbox');
    const lightboxSvgContent = document.getElementById('lightbox-svg-content');
    const closeBtn = document.getElementById('close-btn');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');

    const observer = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const object = entry.target;
                const dataSrc = object.getAttribute('data-data');

                if (dataSrc) {
                    object.data = dataSrc;
                    object.onload = () => object.classList.add('loaded');
                    observer.unobserve(object);
                }
            }
        });
    }, {
        rootMargin: '0px 0px 50px 0px',
        threshold: 0.1
    });

    function renderThumbnails() {
        svgFiles.forEach((svgData, index) => {
            const container = document.createElement('div');
            container.className = 'p-4 bg-white rounded-xl shadow-xl hover:shadow-2xl hover:scale-[1.02] transition-all cursor-pointer flex flex-col items-center space-y-3';
            container.setAttribute('data-index', index);
            container.setAttribute('aria-label', `View ${svgData.name}`);

            const objectMarkup = `
                <object
                    type="image/svg+xml"
                    data=""
                    data-data="${svgData.path}"
                    role="img"
                    aria-label="${svgData.name}"
                    class="transition-all lazy-svg-object"
                    style="pointer-events: none;"
                />
            `;

            container.innerHTML = `
                <div class="w-full aspect-4-5">
                    ${objectMarkup}
                </div>
                <p class="text-sm font-semibold text-gray-700 max-w-full truncate">${svgData.name}</p>
            `;

            container.addEventListener('click', () => openLightbox(index));

            const objectElement = container.querySelector('.lazy-svg-object');
            if (objectElement) {
                observer.observe(objectElement);
            }

            svgGrid.appendChild(container);
        });
    }

    function updateLightboxContent(index) {
        currentIndex = index;
        const svgData = svgFiles[currentIndex];

        lightboxSvgContent.innerHTML = `
            <object
                data="${svgData.path}"
                type="image/svg+xml"
                role="img"
                aria-label="${svgData.name}"
                class="w-full h-full transition-all p-8"
                style="pointer-events: none;"
            />
        `;

        lightbox.setAttribute('aria-label', `Viewing ${svgData.name}`);
    }

    function openLightbox(index) {
        updateLightboxContent(index);
        lightbox.classList.remove('hidden');
        document.body.style.overflow = 'hidden'; // Prevent scrolling the background
    }

    function closeLightbox() {
        lightbox.classList.add('hidden');
        document.body.style.overflow = ''; // Re-enable scrolling
    }

    function showPrevious() {
        const newIndex = (currentIndex - 1 + svgFiles.length) % svgFiles.length;
        updateLightboxContent(newIndex);
    }

    function showNext() {
        const newIndex = (currentIndex + 1) % svgFiles.length;
        updateLightboxContent(newIndex);
    }

    // --- Event Listeners and Initialization ---

    // Close button
    closeBtn.addEventListener('click', closeLightbox);

    // Navigation buttons
    prevBtn.addEventListener('click', showPrevious);
    nextBtn.addEventListener('click', showNext);

    // Keyboard navigation (Escape to close, Arrows to cycle)
    document.addEventListener('keydown', (e) => {
        if (lightbox.classList.contains('hidden')) {
            return; // Only respond if the lightbox is open
        }

        if (e.key === 'Escape') {
            closeLightbox();
        } else if (e.key === 'ArrowLeft') {
            e.preventDefault();
            showPrevious();
        } else if (e.key === 'ArrowRight') {
            e.preventDefault();
            showNext();
        }
    });

    // Initialize the gallery
    window.onload = renderThumbnails;
</script>
</body>
</html>
